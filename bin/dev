#!/usr/bin/env ruby
# frozen_string_literal: true

def installed?(process)
  IO.popen "#{process} -v"
rescue Errno::ENOENT
  false
end

def generate_packs
  puts "ğŸ“¦ Generating React on Rails packs..."
  system "bundle exec rake react_on_rails:generate_packs"
  
  unless $?.success?
    puts "âŒ Pack generation failed"
    exit 1
  end
end

def clean_assets
  puts "ğŸ§¹ Cleaning old Shakapacker assets..."
  system "bundle exec rake shakapacker:clobber"
  
  unless $?.success?
    puts "âš ï¸  Asset cleanup failed, continuing anyway..."
  else
    puts "âœ… Old assets cleaned successfully"
  end
end

def run_production_assets
  puts "ğŸ­ Starting development server with production assets..."
  puts "   - Cleaning old assets with Shakapacker"
  puts "   - Generating React on Rails packs"
  puts "   - Precompiling assets with production optimizations"
  puts "   - Running Rails server on port 3001 (development environment)"
  puts "   - SSL automatically disabled (development environment)"
  puts "   - No HMR (Hot Module Replacement)"
  puts "   - CSS extracted to separate files (no FOUC)"
  puts "   - Using overmind/foreman for process management"
  puts ""
  puts "ğŸ’¡ Access at: http://localhost:3001"
  puts ""
  
  # Clean old assets first
  clean_assets
  
  # Generate React on Rails packs first
  generate_packs
  
  # Precompile assets in production mode for optimization
  puts "ğŸ”¨ Precompiling assets with production optimizations..."
  system "RAILS_ENV=production NODE_ENV=production bundle exec rails assets:precompile"
  
  if $?.success?
    puts "âœ… Assets precompiled successfully"
    puts "ğŸš€ Starting processes with development environment..."
    puts "   (Using production-optimized assets but development Rails config)"
    puts ""
    puts "ğŸ”’ SSL automatically disabled (development environment)"
    puts ""
    
    if installed? "overmind"
      system "RAILS_ENV=development overmind start -f Procfile.dev-prod-assets"
    elsif installed? "foreman"
      system "RAILS_ENV=development foreman start -f Procfile.dev-prod-assets"
    else
      puts "âš ï¸  overmind/foreman not found, falling back to direct Rails server..."
      puts "   For production apps with background jobs, install overmind or foreman"
      puts ""
      puts "Press Ctrl+C to stop the server"
      puts ""
      system "RAILS_ENV=development bundle exec rails server -p 3001"
    end
  else
    puts "âŒ Asset precompilation failed"
    exit 1
  end
rescue Errno::ENOENT
  warn <<~MSG
    ERROR:
    Please ensure `Procfile.dev-prod-assets` exists in your project!
  MSG
  exit!
end

def run_dev_assets
  puts "âš¡ Starting development server with development assets..."
  puts "   - Generating React on Rails packs"
  puts "   - Using shakapacker --watch (no HMR)"
  puts "   - CSS extracted to separate files (no FOUC)"
  puts "   - Development environment (source maps, faster builds)"
  puts "   - Auto-recompiles on file changes"
  puts ""
  puts "ğŸ’¡ Access at: http://localhost:3000"
  puts ""
  
  # Generate React on Rails packs first
  generate_packs
  
  if installed? "overmind"
    system "overmind start -f Procfile.dev-static-assets"
  elsif installed? "foreman"
    system "foreman start -f Procfile.dev-static-assets"
  else
    warn <<~MSG
      NOTICE:
      For this script to run, you need either 'overmind' or 'foreman' installed on your machine. Please try this script after installing one of them.
    MSG
    exit!
  end
rescue Errno::ENOENT
  warn <<~MSG
    ERROR:
    Please ensure `Procfile.dev-static-assets` exists in your project!
  MSG
  exit!
end

def run_development(process)
  generate_packs
  
  system "#{process} start -f Procfile.dev"
rescue Errno::ENOENT
  warn <<~MSG
    ERROR:
    Please ensure `Procfile.dev` exists in your project!
  MSG
  exit!
end

# Check for arguments
if ARGV[0] == "prod-assets"
  run_production_assets
elsif ARGV[0] == "dev-assets"
  run_dev_assets
elsif ARGV[0] == "help" || ARGV[0] == "--help" || ARGV[0] == "-h"
  puts <<~HELP
    Usage: bin/dev [command]
    
    Commands:
      (none) / hmr        Start development server with HMR (default)
      dev-assets          Start development server with development assets (no HMR, no FOUC)  
      prod-assets         Start development server with production assets (optimized)
      help                Show this help message
      
    HMR Development mode (default):
    â€¢ Hot Module Replacement (HMR) enabled
    â€¢ Automatic React on Rails pack generation
    â€¢ Source maps for debugging
    â€¢ May have Flash of Unstyled Content (FOUC)
    â€¢ Fast recompilation
    â€¢ Access at: http://localhost:3000
    
    Development assets mode:
    â€¢ No HMR (development assets with auto-recompilation)
    â€¢ Automatic React on Rails pack generation
    â€¢ CSS extracted to separate files (no FOUC)
    â€¢ Development environment (faster builds, source maps)
    â€¢ Auto-recompiles on file changes
    â€¢ Access at: http://localhost:3000
    
    Production assets mode:
    â€¢ Automatic Shakapacker asset cleaning (rake shakapacker:clobber)
    â€¢ Automatic React on Rails pack generation
    â€¢ Production-optimized, minified bundles
    â€¢ Extracted CSS files (no FOUC)
    â€¢ Development Rails environment (SSL disabled, no config issues)
    â€¢ Uses overmind/foreman for process management (supports Sidekiq, Redis, etc.)
    â€¢ Optimized for performance testing
    â€¢ Access at: http://localhost:3001
  HELP
elsif ARGV[0] == "hmr" || ARGV[0].nil?
  # Default development mode (HMR)
  if installed? "overmind"
    run_development "overmind"
  elsif installed? "foreman"
    run_development "foreman"
  else
    warn <<~MSG
      NOTICE:
      For this script to run, you need either 'overmind' or 'foreman' installed on your machine. Please try this script after installing one of them.
    MSG
    exit!
  end
else
  # Unknown argument
  puts "Unknown argument: #{ARGV[0]}"
  puts "Run 'bin/dev help' for usage information"
  exit 1
end
